# -*- coding: utf-8 -*-
import os

# order2 ='java -jar /Users/dzih526/workspace/MalwareFeaturesCralwer/ic3-0.2.0/ic3-0.2.0-full.jar \ 
#         -apkormanifest /Users/dzih526/workspace/MalwareFeaturesCralwer/test/com.BirdLiveWallpaper.apk \ 
#         -input /Users/dzih526/workspace/MalwareFeaturesCralwer/intentresult/retargeted \ 
#         -cp /Users/dzih526/Library/Android/sdk/platforms/android-26 \
#         -protobuf /Users/dzih526/workspace/MalwareFeaturesCralwer/test'
# order1 = 'dare -d /Users/dzih526/workspace/MalwareFeaturesCralwer/intentresult \ 
#         /Users/dzih526/workspace/MalwareFeaturesCralwer/Benigh/vapk/com.BirdLiveWallpaper.apk'

def decompile(tmpFamilyPath,tmpApkPath,tmpVarietyPath,family,variety,apk):
    cmd='dare -d '
    outputDirPath=os.path.join(tmpFamilyPath,variety+"_output")
    outputDirPath=os.path.join(outputDirPath,apk[0:-4])
    cmd+=outputDirPath+' '
    cmd+=tmpApkPath
    print(cmd)
    os.system(cmd)
    analyse(tmpFamilyPath,tmpApkPath,tmpVarietyPath,family,variety,apk,outputDirPath)   
    
def analyse(tmpFamilyPath,tmpApkPath,tmpVarietyPath,family,variety,apk,outputDirPath):
    cmd='java -jar -jar /Users/dzih526/workspace/MalwareFeaturesCralwer/ic3-0.2.0/ic3-0.2.0-full.jar '
    cmd+='-apkormanifest '+tmpApkPath+' '
    cmd+='-input '+os.path.join(outputDirPath,'retargeted')+' '
    cmd+='-cp /Users/dzih526/Library/Android/sdk/platforms/android-24/android.jar '
    cmd+='-protobuf '+outputDirPath
    print(cmd)
    os.system(cmd)

def traverse(data):
    families = os.listdir(data)
    for family in families:
        tmpFamilyPath = os.path.join(data,family)
        if (not os.path.isdir(tmpFamilyPath)):
            continue
        varieties=os.listdir(tmpFamilyPath)
        for variety in varieties:
            if (variety[0:7]=='variety'):
                tmpVarietyPath=os.path.join(tmpFamilyPath,variety)
                
                apks = os.listdir(tmpVarietyPath)
                for apk in apks:
                    tmpApkPath = os.path.join(tmpVarietyPath,apk)
                    if (apk[-3:]=='apk'):
                        try:
                            fail=open('failToGetIntent.txt','a')
                            print("processing "+apk,file=fail)
                            decompile(tmpFamilyPath,tmpApkPath,tmpVarietyPath,family,variety,apk)
                            print(apk+" complete",file=fail)
                            fail.close()
                        except Exception as e:
                            print("!!!!!!!!!!! "+family+" "+variety+" "+apk,file=fail)

traverse("/Users/dzih526/workspace/MalwareFeaturesCralwer/data")
